<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buxgalter Pro | Moliya Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background: #010409; color: #c9d1d9; font-family: 'Inter', sans-serif; }
        .glass-card { background: #0d1117; border: 1px solid #30363d; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .input-box { background: #161b22; border: 1px solid #30363d; color: white; border-radius: 12px; width: 100%; padding: 12px; font-weight: bold; }
        .tab-btn { padding: 10px 20px; border-radius: 12px; font-weight: 600; transition: 0.3s; }
        .tab-active { background: #238636; color: white; }
        .tab-inactive { color: #8b949e; }
        .margin-gradient { background: linear-gradient(90deg, #238636, #2ea043); }
    </style>
</head>
<body class="p-4">

    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-black text-white">PRO ANALYTICS</h1>
            <p class="text-xs text-gray-500 uppercase tracking-widest">Business Intelligence v2.0</p>
        </div>
        <div id="statusIndicator" class="h-3 w-3 rounded-full bg-green-500 animate-pulse"></div>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-6 text-center">
        <div class="glass-card">
            <p class="text-[10px] text-gray-400 mb-1">MARJA (%)</p>
            <p id="marginPercent" class="text-2xl font-bold text-green-400">0%</p>
        </div>
        <div class="glass-card">
            <p class="text-[10px] text-gray-400 mb-1">SOF FOYDA</p>
            <p id="netProfit" class="text-xl font-bold text-white">0</p>
        </div>
    </div>

    <div class="glass-card mb-6">
        <div id="financialChart"></div>
    </div>

    <div class="space-y-4 mb-20">
        <div class="glass-card border-l-4 border-blue-500">
            <h4 class="text-sm font-bold mb-4 flex items-center">ðŸ’° DAROMAD</h4>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] text-gray-500">SOTUV NARXI</label>
                    <input type="number" id="price" class="input-box" value="150000" oninput="calculateAll()">
                </div>
                <div>
                    <label class="text-[10px] text-gray-500">SOTUV SONI (OY)</label>
                    <input type="number" id="qty" class="input-box" value="200" oninput="calculateAll()">
                </div>
            </div>
        </div>

        <div class="glass-card border-l-4 border-red-500">
            <h4 class="text-sm font-bold mb-4 flex items-center">ðŸ“‰ XARAJATLAR</h4>
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-gray-500">TANNARX (BIR DONA)</label>
                        <input type="number" id="cost" class="input-box" value="90000" oninput="calculateAll()">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500">OYLIK XARAJATLAR</label>
                        <input type="number" id="fixed" class="input-box" value="5000000" oninput="calculateAll()">
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-4">
            <div class="glass-card">
                <h4 class="text-[10px] text-gray-500 mb-2">ZARARSIZLIK NUQTASI</h4>
                <p id="bePoint" class="text-lg font-bold">Kamida 0 ta sotish kerak</p>
                <div class="w-full bg-gray-800 h-1.5 rounded-full mt-2">
                    <div id="beProgress" class="bg-blue-500 h-1.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-4 left-4 right-4">
        <button onclick="sendDetailedReport()" class="w-full margin-gradient text-white py-4 rounded-2xl font-bold shadow-2xl active:scale-95 transition-transform flex justify-center items-center gap-2">
            ðŸš€ MUKAMMAL HISOBOTNI YUBORISH
        </button>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        let chartOptions = {
            series: [{ name: 'Summa', data: [0, 0, 0, 0] }],
            chart: { type: 'bar', height: 250, toolbar: {show: false}, fontFamily: 'Inter' },
            colors: ['#3b82f6', '#ef4444', '#f59e0b', '#10b981'],
            plotOptions: { bar: { borderRadius: 8, distributed: true } },
            xaxis: { categories: ['Aylanma', 'Xarajat', 'Soliq', 'Foyda'], labels: {style: {colors: '#8b949e', fontSize: '10px'}} },
            theme: { mode: 'dark' },
            dataLabels: { enabled: false }
        };

        let chart = new ApexCharts(document.querySelector("#financialChart"), chartOptions);
        chart.render();

        function calculateAll() {
            const price = parseFloat(document.getElementById('price').value) || 0;
            const qty = parseFloat(document.getElementById('qty').value) || 0;
            const unitCost = parseFloat(document.getElementById('cost').value) || 0;
            const fixedCosts = parseFloat(document.getElementById('fixed').value) || 0;

            const revenue = price * qty;
            const totalUnitCost = unitCost * qty;
            const tax = revenue * 0.04; // 4% aylanma soliq
            const totalExpenses = totalUnitCost + fixedCosts + tax;
            const profit = revenue - totalExpenses;
            
            // Marja Hisobi
            const margin = revenue > 0 ? ((revenue - totalUnitCost) / revenue) * 100 : 0;
            const netMargin = revenue > 0 ? (profit / revenue) * 100 : 0;

            // Zararsizlik nuqtasi (Break-even point)
            const unitContribution = price - unitCost;
            const breakEvenQty = unitContribution > 0 ? Math.ceil(fixedCosts / unitContribution) : 0;

            // UI yangilash
            document.getElementById('marginPercent').innerText = margin.toFixed(1) + "%";
            document.getElementById('netProfit').innerText = profit.toLocaleString() + " so'm";
            document.getElementById('bePoint').innerText = `Kamida ${breakEvenQty} ta sotish kerak`;
            
            let progress = (qty / (breakEvenQty * 2)) * 100;
            document.getElementById('beProgress').style.width = Math.min(progress, 100) + "%";

            // Diagrammani yangilash
            chart.updateSeries([{ data: [revenue, totalUnitCost + fixedCosts, tax, profit] }]);
        }

        function sendDetailedReport() {
            const profit = document.getElementById('netProfit').innerText;
            const margin = document.getElementById('marginPercent').innerText;
            const bep = document.getElementById('bePoint').innerText;
            
            const report = {
                type: "PROFESSIONAL_ANALYSIS",
                profit: profit,
                margin: margin,
                break_even: bep,
                advice: parseFloat(margin) < 20 ? "Diqqat: Marja juda past!" : "Biznes barqaror."
            };

            tg.sendData(JSON.stringify(report));
        }

        calculateAll();
    </script>
</body>
</html>
